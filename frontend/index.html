<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Asesoría Técnica Inteligente</title>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: #f4f7f6; display: flex; justify-co>
        .container { background: white; width: 100%; max-width: 500px; padding: 30px; border-radius: 12px; box-shadow: 0 4px 15px>
        h2 { color: #2c3e50; text-align: center; }
        .hidden { display: none; }
        .question { font-weight: bold; margin-bottom: 15px; display: block; color: #34495e; }
        textarea { width: 100%; height: 120px; padding: 10px; border: 1px solid #ddd; border-radius: 8px; resize: none; box-sizin>

        /* Botones */
        button { background-color: #3498db; color: white; border: none; padding: 12px 20px; border-radius: 8px; cursor: pointer; >
        button:hover { background-color: #2980b9; }
        button:disabled { background-color: #95a5a6; cursor: not-allowed; }

        /* Animaciones de Carga */
        .spinner { border: 4px solid #f3f3f3; border-top: 4px solid #3498db; border-radius: 50%; width: 30px; height: 30px; anima>
        .spinner-small { border: 3px solid rgba(255,255,255,0.3); border-top: 3px solid #fff; border-radius: 50%; width: 20px; he>

        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        .summary-box { background: #e8f4fd; padding: 15px; border-radius: 8px; border-left: 4px solid #3498db; margin-bottom: 20p>
        .form-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 5px; font-size: 14px; color: #666; }
        input { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; box-sizing: border-box; }
    </style>
</head>
<body>

<div class="container">
    <h2>Consultoría Técnica</h2>

    <!-- PASO 1 -->
    <div id="step-1">
        <span class="question">¿Cómo te puedo ayudar con tu proyecto hoy?</span>
        <textarea id="client-input" placeholder="Describe brevemente tu requerimiento..."></textarea>
        <button onclick="sendToIA()">Solicitar revisión de factibilidad</button>
    </div>

    <!-- PASO 2: CARGA IA -->
    <div id="step-loading" class="hidden">
        <div class="spinner"></div>
        <p id="loading-msg" style="text-align: center; color: #666;">Iniciando análisis...</p>
    </div>
 <!-- PASO 3: RESUMEN IA -->
    <div id="step-2" class="hidden">
        <span class="question">Esto es lo que he comprendido:</span>
        <div id="ia-summary" class="summary-box"></div>
        <p>¿Es correcta esta interpretación?</p>
        <button onclick="showForm()">Sí, es correcto. Solicitar presupuesto</button>
        <button style="background-color: #95a5a6;" onclick="location.reload()">No, quiero corregir</button>
    </div>

    <!-- PASO 4: FORMULARIO -->
    <div id="step-3" class="hidden">
        <span class="question">Ingrese sus datos para el presupuesto:</span>
        <div class="form-group"><label>Nombre Completo</label><input type="text" id="name"></div>
        <div class="form-group"><label>Teléfono</label><input type="tel" id="phone"></div>
        <div class="form-group"><label>Email</label><input type="email" id="email"></div>

        <!-- Botón Final con ID para manipularlo -->
        <button id="btn-final" style="background-color: #27ae60;" onclick="finalizarSolicitud()">Enviar Solicitud Final</button>
        <p id="msg-final" style="text-align: center; font-size: 12px; color: #888; display: none;">Guardando datos en el servidor>
    </div>
</div>

<script>
    const SERVER_IP = window.location.hostname;
    const phrases = ["Analizando factibilidad...", "Revisando normativas...", "Preparando resumen técnico...", "Redactando respue>

    async function sendToIA() {
        const input = document.getElementById('client-input').value;
        if (!input) return alert("Por favor escribe algo.");

        document.getElementById('step-1').classList.add('hidden');
        document.getElementById('step-loading').classList.remove('hidden');

        let phraseIdx = 0;
        const phraseInterval = setInterval(() => {
            phraseIdx = (phraseIdx + 1) % phrases.length;
            document.getElementById('loading-msg').innerText = phrases[phraseIdx];
        }, 3000);

        try {
            const response = await fetch(`/ollama/api/chat`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    model: "qwen2.5:3b",
                    messages: [
                        { role: "system", content: "Actúa como consultor experto. Resume el requerimiento en 2 párrafos técnicos >
                        { role: "user", content: input }
                    ],
                    stream: false
                })
            });
            const data = await response.json();
            clearInterval(phraseInterval);
            document.getElementById('ia-summary').innerText = data.message.content;
            document.getElementById('step-loading').classList.add('hidden');
            document.getElementById('step-2').classList.remove('hidden');
        } catch (error) {
            alert("Error conectando con la IA.");
            location.reload();
        }
    }

    function showForm() {
        document.getElementById('step-2').classList.add('hidden');
        document.getElementById('step-3').classList.remove('hidden');
    }

    async function finalizarSolicitud() {
    const name = document.getElementById('name').value;
    const phone = document.getElementById('phone').value;
    const email = document.getElementById('email').value;
    const summary = document.getElementById('ia-summary').innerText;
    const original = document.getElementById('client-input').value;

    if (!name || !phone || !email) {
        alert("Por favor, completa todos los campos.");
        return;
    }

    // --- ACTIVAR ANIMACIÓN (Lo que ya tenías) ---
    const btn = document.querySelector('.btn-finalizar');
    const loadingHtml = '<div class="spinner"></div> Enviando...'; // Ajusta esto a tu HTML de carga
    const originalText = btn.innerHTML;

    btn.disabled = true;
    btn.innerHTML = loadingHtml;

    try {
        const response = await fetch('/secretario/guardar', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                nombre: name,
                telefono: phone,
                correo: email,
                resumen: summary,
                texto_original: original
            })
        });

        if (response.ok) {
            alert("✅ ¡Solicitud enviada con éxito!");
            location.reload();
        } else {
            throw new Error("Error en el servidor");
        }

    } catch (error) {
        console.error("Error:", error);
        alert("⚠️ La conexión se interrumpió (posiblemente al apagarse la pantalla). Por favor, intenta de nuevo.");

        // --- QUITAR ANIMACIÓN SI FALLA ---
        // Esto es clave: si falla, devolvemos el botón a la normalidad
        btn.disabled = false;
        btn.innerHTML = originalText;
    }
}
window.onpageshow = function(event) {
    if (event.persisted) {
        // Si el usuario volvió usando el botón "atrás"
        window.location.reload(); // Forzamos recarga para limpiar todo
    }
};

</script>
</body>
</html>
